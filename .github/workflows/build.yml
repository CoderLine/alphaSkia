on:
  workflow_dispatch:
    inputs:
      use-skia-cache:
        type: boolean
        description: Use Skia Binary from cache
        default: 'false'

jobs:

#
# Windows
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, x86, arm64]
        variant: ['shared', 'static']
    steps:
      - uses: ../actions/build-skia
        with:
          use-cache: ${{ inputs.use-skia-cache }}
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: windows
  windows-jni:
    runs-on: windows-latest
    needs: [windows]
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, x86, arm64]
        variant: ['shared']
    steps:
      - uses: ../actions/build-jni
        with:
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: windows

#
# Linux
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64]
        # TODO architecture: [x64, x86, arm64]
        variant: ['shared', 'static']
    steps:
      - uses: ../actions/build-skia
        with:
          use-cache: ${{ inputs.use-skia-cache }}
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: linux
  linux-jni:
    runs-on: ubuntu-latest
    needs: [linux]
    strategy:
      fail-fast: false
      matrix:
        # TODO architecture: [x64, x86, arm64]
        architecture: [x64]
        variant: ['shared']
    steps:
      - uses: ../actions/build-jni
        with:
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: linux

#
# Android
  android:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, x86, arm, arm64]
        variant: ['shared', 'static']
    steps:
      - uses: ../actions/build-skia
        with:
          use-cache: ${{ inputs.use-skia-cache }}
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: android
  android-jni:
    runs-on: ubuntu-latest
    needs: [android]
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, x86, arm, arm64]
        variant: ['shared']
    steps:
      - uses: ../actions/build-jni
        with:
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: android
#
# MacOs
  macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, arm64]
        variant: ['shared', 'static']
    steps:
      - uses: ../actions/build-skia
        with:
          use-cache: ${{ inputs.use-skia-cache }}
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: macos
  macos-jni:
    runs-on: macos-latest
    needs: [macos]
    strategy:
      fail-fast: false
      matrix:
        architecture: [x64, arm64]
        variant: ['shared']
    steps:
      - uses: ../actions/build-jni
        with:
          architecture: ${{ matrix.architecture }}
          variant: ${{ matrix.variant }}
          target-os: macos
#
# Libraries
  dotnet:
    runs-on: windows-latest
    needs: [windows, linux, android, macos]
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - uses: actions/download-artifact@v3
      with:
        path: dist
    - run: ./build.cmd DotNet
    - uses: actions/upload-artifact@v3
      with:
        name: Nupkgs
        path: |
          lib/dotnet/**/bin/Release/*.nupkg
          lib/dotnet/**/bin/Release/*.snupkg

  java:
    runs-on: ubuntu-latest
    needs: [windows-jni, linux-jni, android-jni, macos-jni]
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - uses: actions/download-artifact@v3
      with:
        path: dist
    - run: ./build.cmd Java
    - uses: actions/upload-artifact@v3
      with:
        name: Jars
        path: |
          lib/java/*/build/libs/*.jar
